<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">

    <title>SQRL |  </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/sqrl/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/sqrl/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"path":"language/simple.html","title":""},"data":{"navigation":{"logo":{"text":"SQRL Documentation","type":"link","path":"index.html"},"main":[{"text":"Documentation","type":"link","path":"index.html"},{"text":"Examples","type":"label","children":[{"text":"Redis Database","type":"link","path":"examples/redis.html"},{"text":"REPL","type":"link","path":"examples/repl.html"},{"text":"Wikipedia","type":"link","path":"examples/wikipedia.html"}]},{"text":"Language","type":"label","children":[{"text":"Simple Counters","type":"link","path":"language/simple.html"},{"text":"Unique Counters","type":"link","path":"language/unique.html"},{"text":"Rate limiters","type":"link","path":"language/ratelimit.html"},{"text":"Sessionization","type":"link","path":"language/session.html"},{"text":"Text Pattern Matching","type":"link","path":"language/textpattern.html"},{"text":"Where Clauses","type":"link","path":"language/where.html"}]},{"text":"Defining Functions","type":"label","children":[{"text":"Simple Functions","type":"link","path":"functions/simple.html"},{"text":"Statements","type":"link","path":"functions/statement.html"},{"text":"When Clauses","type":"link","path":"functions/when.html"},{"text":"Custom Functions","type":"link","path":"functions/custom.html"}]},{"text":"Production Deployments","type":"label","children":[{"text":"Http Server","type":"link","path":"deployment/server.html"},{"text":"Async Queues","type":"link","path":"deployment/async.html"}]}]}},"config":{"timezone":"UTC","root":"/sqrl/","time_format":"HH:mm:ss","theme":"hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><a href="/sqrl/index.html" class="doc-navbar__logo"><img src="/sqrl/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">SQRL Documentation</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <p>Another powerful tool at your disposal is the ability to flexibly count across multiple timespans. Let’s get started with a simple count.</p>
<p>Your first counter<br>In this example we are going to set up some counters for a message action in message.sqrl and make sure we include that from main.sqrl. Here’s an example of a simple counter that counts the number of action by a given SessionActor in the last week.</p>
<p>rules/message.sqrl</p>
<p>LET NumMessages := count(BY SessionActor LAST WEEK);</p>
<p>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>
<p>Understanding the BY clause<br>You can create a counter by one or more features. In the above example for each unique SessionActor we have created another counter of the number of actions performed in the last week.</p>
<p>For certain use cases you’ll want to count pairwise features. Perhaps you’ll want to know the number of messages the given user sent on this Ip as compared to the number he has sent total. That is easy to do just by comma separating the features.</p>
<p>rules/message.sqrl<br>LET NumMessages := count(BY SessionActor LAST HOUR); LET NumIpMessages := count(BY SessionActor, Ip LAST HOUR); LET PercentMessagesByIp = 100 * (NumIpMessages / NumMessages);</p>
<p>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>
<p>Available timespans<br>The LAST clause specifies the timespan we want to count by. For simple counters we do not allow custom timespans, even though we do for unique counts.</p>
<p>The list of available timespans are:</p>
<p>TOTAL<br>LAST 180 DAYS<br>LAST MONTH<br>LAST TWO WEEKS<br>LAST EIGHT DAYS<br>LAST TWO DAYS<br>LAST DAY<br>LAST HOUR<br>Counting with conditions<br>In the previous example we were only counting actions WHERE ActionName=”message”. It is very easy to create more interesting counters by passing in a WHERE statement as well.</p>
<p>Let’s imagine you were interested in tracking users who had a high percentage of messages with profanity. We could easily accomplish this by tracking two counts.</p>
<p>rules/message.sqrl</p>
<p>LET NumMessagesWithProfanity := count( BY SessionActor WHERE TextWithStrongProfanity LAST WEEK); LET NumMessagesWithoutProfanity := count( BY SessionActor WHERE NOT TextWithStrongProfanity LAST WEEK);<br>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>
<p>Here we have set up two counters – NumMessagesWithProfanity will be increased when the text contains profanity, otherwise NumMessagesWithoutProfanity will be increased. Both counters are available to be read on every action.</p>
<p>Restrictions on conditions in WHERE clauses<br>For reasons discussed under where expressions in our advanced documentation there are strict restrictions on what you can put in a WHERE clause. Anything other than simple equality, AND, OR, and NOT is not allowed.</p>
<p>Since ActorAgeDays &lt; 10 is invalid inside a counter where statement, if you wanted to only count messages by new actors you’ll need to create another feature.</p>
<p>The example below creates IsYoungActor and uses that in order to count how many messages were sent on the current ip address by users created in the last ten days.</p>
<p>rules/message.sqrl</p>
<p>LET IsYoungActor := ActorAgeDays &lt; 10; LET NumMessagesByYoungActorsOnIp := count(BY Ip WHERE IsYoungActor);</p>
<p>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>
<p>Labeling users that use a high percentage of profanity<br>To tie it all together we could create a rule for flagging users who have a high percentage of messages containing profanity.</p>
<p>rules/message.sqrl</p>
<p>LET NumMessagesWithProfanity := count(<br>  BY SessionActor WHERE TextWithStrongProfanity LAST WEEK);<br>LET NumMessagesWithoutProfanity := count(<br>  BY SessionActor WHERE NOT TextWithStrongProfanity LAST WEEK);</p>
<h1 id="Keep-track-of-total-and-percentage-so-we-can-use-in-reason-string"><a href="#Keep-track-of-total-and-percentage-so-we-can-use-in-reason-string" class="headerlink" title="Keep track of total and percentage so we can use in reason string."></a>Keep track of total and percentage so we can use in reason string.</h1><p>LET TotalMessages := NumWithProfanity + NumWithoutProfanity;<br>LET PercentProfaneMessages := NumWithProfanity / TotalMessages;<br>CREATE RULE HighPercentageProfanity<br>  WHERE PercentProfaneMessages &gt; 0.5 AND TotalMessages &gt; 2<br>  ROLLOUT TO 100%;</p>
<p>WHEN HighPercentageProfanity<br>  BLOCK ACTION<br>  ADD “bad_user” TO SessionActor;<br>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>
<p>We could just have easily tracked users who received lots of profane messages and either block the action or label the recipient to trigger some form of outreach. Let’s look at what that code would look like:</p>
<p>rules/message.sqrl</p>
<p>LET NumReceivedWithProfanity := count(<br>  BY Target WHERE TextWithStrongProfanity LAST WEEK);<br>LET NumReceivedWithoutProfanity := count(<br>  BY Target WHERE NOT TextWithStrongProfanity LAST WEEK);</p>
<h1 id="Keep-track-of-total-and-percentage-so-we-can-use-in-reason-string-1"><a href="#Keep-track-of-total-and-percentage-so-we-can-use-in-reason-string-1" class="headerlink" title="Keep track of total and percentage so we can use in reason string."></a>Keep track of total and percentage so we can use in reason string.</h1><p>LET TotalReceived := NumReceivedWithProfanity + NumReceivedWithoutProfanity;<br>LET PercentProfaneReceived := NumReceivedWithProfanity / TotalReceived;<br>CREATE RULE HighPercentageProfanityReceived<br>  WHERE PercentProfaneReceived &gt; 0.5 AND TotalReceived &gt; 2<br>  ROLLOUT TO 100%;</p>
<p>WHEN HighPercentageProfanityReceived<br>  BLOCK ACTION<br>  ADD “harassment_recipient” TO Target;</p>
<p>rules/main.sqrl</p>
<p>INCLUDE “message.sqrl” WHERE ActionName=”message”;</p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/sqrl/script/doc.js"></script>

    

  </body>
</html>
